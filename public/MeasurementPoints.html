<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Målepunkter</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; margin: 0; }
    .container { max-width: 1100px; margin: 0 auto; padding: 24px; }
    .grid { display: grid; gap: 16px; }
    @media (min-width: 1024px) { .lg\:grid-cols-3 { grid-template-columns: 2fr 1fr; } }
    .card { border: 1px solid #e5e7eb; border-radius: 8px; background: white; }
    .card-header { padding: 12px 16px; border-bottom: 1px solid #f3f4f6; }
    .card-content { padding: 16px; }
    .muted { color:#6b7280; }
    .dot { width:18px; height:18px; border-radius:50%; border:2px solid white; box-shadow:0 1px 3px rgba(0,0,0,0.2); position:absolute; transform:translate(-50%,-50%); cursor:pointer; }
    .modal { position:fixed; left:0; right:0; top:0; bottom:0; background:rgba(0,0,0,0.4); display:flex; align-items:center; justify-content:center; }
    .modal .panel { background:white; padding:16px; border-radius:8px; width:320px; }
    table { width:100%; border-collapse:collapse; }
    td, th { padding:8px; border-bottom:1px solid #eee; font-size:14px; }
    .btn { padding:6px 10px; border-radius:6px; cursor:pointer; }
    .btn-ghost { background:transparent; border:1px solid #e5e7eb; }
  </style>
</head>
<body>
  <div class="container">
    <div class="mb-6">
      <h1 class="mb-2">Målepunkter</h1>
      <p class="muted">Klik på kortet for at tilføje målepunkter</p>
    </div>

    <div class="grid lg:grid-cols-3">
      <div class="card">
        <div class="card-header"><strong>Interaktivt kort</strong><div class="muted">Klik for at tilføje nye målepunkter</div></div>
        <div class="card-content" id="mapArea" style="position:relative; min-height:480px;">
          <div id="mapPlaceholder" style="border:1px dashed #cbd5e1; border-radius:6px; height:480px; display:flex; align-items:center; justify-content:center;">
            <div style="text-align:center; color:#9ca3af;">Upload en plantegning først</div>
          </div>
        </div>
      </div>

      <div>
        <div class="card" style="margin-bottom:12px;">
          <div class="card-header"><strong>Statistik</strong></div>
          <div class="card-content">
            <div>Totale målepunkter: <strong id="totalCount">0</strong></div>
            <div>Gns. signalstyrke: <strong id="avgSignal">0</strong> dBm</div>
            <div>Unikke SSIDs: <strong id="uniqueSsids">0</strong></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><strong>Målepunkter oversigt</strong></div>
          <div class="card-content" style="max-height:300px; overflow:auto;">
            <table id="pointsTable">
              <thead><tr><th>Pos</th><th>Signal</th><th>SSID</th><th></th></tr></thead>
              <tbody><tr><td colspan="4" class="muted">Ingen målepunkter endnu.</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="modal" style="display:none;" class="modal">
    <div class="panel">
      <h3 id="modalTitle">Tilføj målepunkt</h3>
      <div style="margin-top:8px;">
        <label>Signalstyrke (dBm)</label>
        <input id="inSignal" type="number" value="-60" style="width:100%; padding:6px; margin-top:6px;" />
      </div>
      <div style="margin-top:8px;">
        <label>SSID</label>
        <input id="inSsid" style="width:100%; padding:6px; margin-top:6px;" />
      </div>
      <div style="margin-top:8px;">
        <label>BSSID</label>
        <input id="inBssid" style="width:100%; padding:6px; margin-top:6px;" />
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
        <button id="cancelBtn" class="btn btn-ghost">Annuller</button>
        <button id="saveBtn" class="btn">Gem</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      let floorPlan = null;
      let measurements = [];
      let selectedPoint = null;
      const mapArea = document.getElementById('mapArea');
      const mapPlaceholder = document.getElementById('mapPlaceholder');
      const totalCount = document.getElementById('totalCount');
      const avgSignal = document.getElementById('avgSignal');
      const uniqueSsids = document.getElementById('uniqueSsids');
      const pointsTable = document.querySelector('#pointsTable tbody');
      const modal = document.getElementById('modal');
      const inSignal = document.getElementById('inSignal');
      const inSsid = document.getElementById('inSsid');
      const inBssid = document.getElementById('inBssid');
      const saveBtn = document.getElementById('saveBtn');
      const cancelBtn = document.getElementById('cancelBtn');
      const modalTitle = document.getElementById('modalTitle');

      function renderMap() {
        mapArea.innerHTML = '';
        if (!floorPlan) {
          mapArea.appendChild(mapPlaceholder);
          return;
        }
        const img = document.createElement('img');
        img.src = floorPlan.imageUrl;
        img.style.width = '100%';
        img.style.height = 'auto';
        img.style.display = 'block';
        const wrapper = document.createElement('div');
        wrapper.style.position = 'relative';
        wrapper.appendChild(img);
        wrapper.addEventListener('click', function(e){
          const rect = img.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;
          selectedPoint = { x, y };
          openModal('add');
        });

        // add markers
        measurements.forEach(m => {
          const dot = document.createElement('div');
          dot.className = 'dot';
          dot.style.left = (m.x) + 'px';
          dot.style.top = (m.y) + 'px';
          dot.style.background = m.signalStrength >= -60 ? '#22c55e' : (m.signalStrength >= -70 ? '#eab308' : '#ef4444');
          dot.title = m.signalStrength + ' dBm';
          dot.addEventListener('click', function(ev){ ev.stopPropagation(); openModal('edit', m); });
          wrapper.appendChild(dot);
        });

        mapArea.appendChild(wrapper);
      }

      function renderStats() {
        totalCount.textContent = String(measurements.length);
        avgSignal.textContent = measurements.length > 0 ? String(Math.round(measurements.reduce((a,b)=>a+b.signalStrength,0)/measurements.length)) : '0';
        uniqueSsids.textContent = String(new Set(measurements.map(m=>m.ssid)).size);
      }

      function renderTable() {
        pointsTable.innerHTML = '';
        if (measurements.length === 0) {
          const tr = document.createElement('tr');
          const td = document.createElement('td'); td.colSpan = 4; td.className = 'muted'; td.textContent = 'Ingen målepunkter endnu.'; tr.appendChild(td); pointsTable.appendChild(tr); return;
        }
        measurements.forEach(m => {
          const tr = document.createElement('tr');
          const pos = document.createElement('td'); pos.textContent = `(${Math.round(m.x)}, ${Math.round(m.y)})`; tr.appendChild(pos);
          const sig = document.createElement('td'); sig.textContent = m.signalStrength + ' dBm'; tr.appendChild(sig);
          const ssid = document.createElement('td'); ssid.textContent = m.ssid; tr.appendChild(ssid);
          const actions = document.createElement('td');
          const editBtn = document.createElement('button'); editBtn.className='btn btn-ghost'; editBtn.textContent='Edit'; editBtn.addEventListener('click', ()=>openModal('edit', m));
          const delBtn = document.createElement('button'); delBtn.className='btn btn-ghost'; delBtn.textContent='Delete'; delBtn.addEventListener('click', ()=>{ if(confirm('Slet?')) { postDelete(m.id); } });
          actions.appendChild(editBtn); actions.appendChild(delBtn); tr.appendChild(actions);
          pointsTable.appendChild(tr);
        });
      }

      function openModal(mode, m) {
        modalTitle.textContent = mode === 'add' ? 'Tilføj målepunkt' : 'Rediger målepunkt';
        if (mode === 'edit' && m) {
          inSignal.value = String(m.signalStrength);
          inSsid.value = m.ssid || '';
          inBssid.value = m.bssid || '';
          modal.dataset.mode = 'edit';
          modal.dataset.id = m.id;
        } else {
          inSignal.value = '-60'; inSsid.value = ''; inBssid.value = '';
          modal.dataset.mode = 'add'; delete modal.dataset.id;
        }
        modal.style.display = 'flex';
      }

      cancelBtn.addEventListener('click', function(){ modal.style.display = 'none'; });

      saveBtn.addEventListener('click', function(){
        const mode = modal.dataset.mode;
        const measurement = {
          id: mode === 'edit' ? modal.dataset.id : 'm-'+Date.now(),
          x: selectedPoint ? selectedPoint.x : (mode === 'edit' ? measurements.find(mm=>mm.id===modal.dataset.id).x : 0),
          y: selectedPoint ? selectedPoint.y : (mode === 'edit' ? measurements.find(mm=>mm.id===modal.dataset.id).y : 0),
          signalStrength: parseFloat(inSignal.value),
          ssid: inSsid.value,
          bssid: inBssid.value,
          frequency: 2400,
          channel: 6,
          timestamp: new Date().toISOString(),
          notes: ''
        };
        if (mode === 'edit') {
          postUpdate(measurement.id, measurement);
        } else {
          postAdd(measurement);
        }
        modal.style.display = 'none';
        selectedPoint = null;
      });

      function postAdd(measurement) {
        if (window.parent && typeof window.parent.postMessage === 'function') {
          window.parent.postMessage({ type: 'measurement:add', measurement }, '*');
        }
      }
      function postUpdate(id, measurement) {
        if (window.parent && typeof window.parent.postMessage === 'function') {
          window.parent.postMessage({ type: 'measurement:update', id, measurement }, '*');
        }
      }
      function postDelete(id) {
        if (window.parent && typeof window.parent.postMessage === 'function') {
          window.parent.postMessage({ type: 'measurement:delete', id }, '*');
        }
      }

      // Listen for messages from parent
      window.addEventListener('message', function(ev){
        try {
          const msg = ev.data || {};
          if (msg.type === 'measurements:set') {
            measurements = Array.isArray(msg.measurements) ? msg.measurements : [];
            renderMap(); renderStats(); renderTable();
          }
          if (msg.type === 'measurements:setFloorPlan') {
            floorPlan = msg.floorPlan || null;
            renderMap();
          }
        } catch (err) { }
      }, false);

      // Request initial data
      if (window.parent && typeof window.parent.postMessage === 'function') {
        window.parent.postMessage({ type: 'measurements:ready' }, '*');
      }

    })();
  </script>
</body>
</html>